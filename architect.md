# 主にサーバーサイド視点の要件定義

お題：サーバーサイドとフロントサイドとの通信形態を考える

## データのやり取り形式

特定のエンドポイント URL に JSON でポスト  
 -> JSON 形式の result Object を返す

## データの変換形式

result Object の形式を以下のように定義する

### 1. 正常なレスポンスの場合

- result
- data
  - response data

```json
{
  "result": "success",
  "data": {
    "data1": "data",
    "data2": "data"
  }
}
```

### 2. エラーの場合

- result
- data
  - errorCode
  - errorMessage

```json
{
  "result": "error",
  "data": {
    "errorCode": 100,
    "errorMessage": "error message is here."
  }
}
```

## a.アカウント関係(ユーザーサイドの操作)

- アカウント登録
- ログイン操作
- ログアウト操作
- アカウント消去

### 1. アカウント登録時

#### 通信内容

- 入力されたユーザー情報をデータベースに登録
- 結果をフロントサイドに送信

#### DB

- Users : INSERT

#### 備考

サーバーサイド側、フロント側での二重チェック必須

### 2. アカウントログイン時

#### 通信内容

- 外部プロバイダから認証情報を取得
- 取得した認証情報に紐づけられた固有の ID に対応するユーザーアカウント情報を DB より取得
- 結果をフロントサイドに送信

#### DB

- Users : SELECT

### 3. アカウント登録情報変更時

#### 通信内容

- 更新したい情報と、更新したいユーザーテーブルの ID をデータベースに送信
- 該当のユーザーアカウント情報を更新する
- 結果をフロントサイドに送信

#### DB

- Users : UPDATE

### 4. アカウント消去時

#### 通信内容

- 消去したいユーザーテーブルの ID をデータベースに送信
- 紐づけられたユーザーアカウントに対する処理（友達から削除するなど）
  - 議論：<b style="color: red">リクエスト送信済みのアカウント情報って見れた方が良いか？</b>
- 該当のユーザーアカウント情報を消去する
- 結果をフロントサイドに送信

#### DB

- Users : DELETE, UPDATE

## b.アカウント関係(運営サイドの操作)

<b style="color: red">必要かどうかは要件定義の議論が必要</b>

- アカウントステータスを変更
  - 通常状態、凍結状態、部分的な制限状態？
- アカウントそのものを消去

### 1. アカウント凍結

#### 通信内容

議論：<b style="color: red">必要な昨日か？</b>

- ステータスを変更したいユーザーテーブルの ID をデータベースに送信
- 該当ユーザーのアカウントステータスを変更
- ユーザーに通知を送信する（メールとか）
- 結果をフロントサイドに送信

#### DB

- Users : DELETE, UPDATE

### 2. アカウント消去

#### 通信内容

- 消去したいユーザーテーブルの ID をデータベースに送信
- 紐づけられたユーザーアカウントに対する処理（友達から削除するなど）
  - 議論：<b style="color: red">リクエスト送信済みのアカウント情報って見れた方が良いか？</b>
- 該当のユーザーアカウント情報を消去する
- ユーザーに通知する（メールアドレス経由）

#### DB

- Users : DELETE, UPDATE

## c.アプリ関係(ユーザーサイドの操作)

- 近くのユーザー取得
- リクエスト送信時
  - チケット消費
  - リクエスト送受信の記録を保持
- リクエスト操作時
  - リクエスト許可
    - リクエスト許可を反映 (Friend リスト入り)
    - チャットルーム開設
  - リクエスト拒否
    - リクエスト拒否を反映（NG リスト入り）

### 1. 近くのユーザー探索時

#### 通信内容

- ユーザーの現在地をサーバー側に送信
  - <b style="color: red">手動で近くのユーザーリストを更新する機能を載せるかどうか？</b>
  - <b style="color: red">あるいは、一定周期で自動更新する形にするか？</b>
    - サーバー側の負担を考慮する上で結構重要なので、要件定義したい
- 受信した現在地付近にいるユーザー ID を取得？
- 取得したユーザー ID に基づいたユーザーデータを抽出
- フロントに結果を返す

#### DB

- func getNearByUsers()
- Users : SELECT

### 2. チケット購入時・消費時

#### 通信内容

- 操作を行うユーザー ID と、操作内容（購入・消費）をサーバーに送信
- 操作内容に応じて、ユーザーに紐づけられたチケットを減らしたり増やしたりする
- 結果をフロントに送信

#### DB

- func handleTickets(manumulationContent)
- Users: SELECT, UPDATE

### 3. リクエスト送信時

#### 通信内容

- リクエストを送信する側、送信する側双方のユーザー ID を送信
- リクエスト送信側のユーザーに操作を記録
  - User.request.sent に記録
- リクエスト受信側のユーザーに操作を記録
  - User.request.received に記録
- 相手ユーザーに通知を送信
- 結果をフロントに送信

#### DB

- Users : SELECT, UPDATE
- func sendNotification()

### 4. リクエスト許可時

#### 通信内容

- リクエスト許可する側、される側双方のユーザー ID を送信
- リクエスト許可する側のユーザーに操作を記録
  - FriendList に相手のユーザー ID を追加
  - User.request.received から相手のユーザー ID を削除
- リクエスト許可される側のユーザーに操作を記録
  - FriendList に相手のユーザー ID を追加
  - User.request.sent から相手のユーザー ID を削除
- 双方のユーザーに通知を送信
- フロントに結果を送信

#### DB

- Users: SELECT, UPDATE, DELETE
- func sendNotification()

### 5. リクエスト拒否時

#### 通信内容

- リクエスト拒否する側、される側双方のユーザー ID を送信
- リクエスト拒否する側のユーザーに操作を記録
  - User.request.received から相手のユーザー ID を削除
  - User.request.rejected に相手のユーザー ID を追加
- リクエスト許可される側のユーザーに操作を記録
  - User.request.sent から相手のユーザー ID を削除
    - <b style="color: red">そのまま放置でも良い？ユーザーが任意に消去できるような機能を実装すれば、全然許可しないやつのこと悟ってくれそう</b>

#### DB

- Users: SELECT, UPDATE, INSERT

### 3. チャット送信時

#### 通信内容

- 入力データをサーバーに送信
- ChatRooms データベースの該当 Table に値を追加
- 相手ユーザーに通知を送信
- 結果をフロントに送信

#### DB

- ChatRooms: SELECT, INSERT
- func sendNotification()

#### 通信内容

- 通知とデータを同時に受信
  - <b style="color: red">通知を受信してから改めてサーバーにデータ要求は無駄すぎると思うので同時が良い</b>
- あとはフロントのお仕事
- <b style="color: red">既読機能は必要か？初対面で相手を探るためのチャットなので実装するべきではないと判断</b>
  - 実装するなら本項目を更新する必要あり

## その他：サーバーサイドでの自動実行

- エラーログを取る
  - 受信エンドポイント、フロントから受信したデータ、エラー発生段階、エラー内容、日時、サーバー負荷状況を記録
- 通知送信
  - 別途運営葉のアプリケーションから、ユーザー全体に対する通知を送信する

## フロント側への要望

- アップデートを強制する仕組みが欲しい

  - 互換性がなくなるアップデートに対応するため

- webSocket などを用いた常時通信の仕組みが欲しい
  - チャット関係と、それ以外（運営側、リクエスト通知受信など）とで設計を分ける？
